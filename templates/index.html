<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘å®æ—¶æ ‡è®°ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }
        
        .upload-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .upload-form {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .upload-form input[type="file"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .upload-form button {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .upload-form button:hover {
            background-color: #2980b9;
        }
        
        .main-content {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .video-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex: 2;
            min-width: 300px;
        }
        
        .controls-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 140px);
        }
        
        video {
            width: 100%;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .video-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .video-controls button {
            padding: 8px 16px;
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .video-controls button:hover {
            background-color: #229954;
        }
        
        .video-controls button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .video-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .info-label {
            font-weight: bold;
            color: #555;
            font-size: 13px;
        }
        
        .info-item span:last-child {
            color: #2c3e50;
            font-size: 13px;
        }
        
        .controls-section h3 {
            flex-shrink: 0;
        }
        
        .controls-section > div:not(.classes-grid) {
            flex-shrink: 0;
        }
        
        .classes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
            min-height: 200px;
            align-content: start;
        }
        
        .class-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background-color: #f9f9f9;
            border-radius: 4px;
            height: fit-content;
        }
        
        .class-item input[type="checkbox"] {
            transform: scale(1.2);
        }
        
        .class-item label {
            cursor: pointer;
            user-select: none;
        }
        
        .status {
            margin-top: 15px;
            padding: 10px;
            background-color: #e8f4f8;
            border-left: 4px solid #3498db;
            border-radius: 4px;
        }
        
        .status.error {
            background-color: #f8e8e8;
            border-left-color: #e74c3c;
        }
        
        .status.success {
            background-color: #e8f8e8;
            border-left-color: #27ae60;
        }
        
        .timeline-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .timeline-container {
            position: relative;
            min-height: 200px;
            max-height: 600px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            transition: height 0.3s ease;
        }
        
        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .timeline-header h4 {
            margin: 0;
            color: #2c3e50;
        }
        
        .timeline-info {
            font-size: 12px;
            color: #666;
            padding: 5px 10px;
            background: #f0f0f0;
            border-radius: 3px;
        }
        
        .timeline-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .timeline-controls select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
            background: white;
            cursor: pointer;
        }
        
        .timeline-controls label {
            font-size: 12px;
            color: #666;
        }
        
        /* ExportåŠŸèƒ½æ ·å¼ */
        .export-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            flex-shrink: 0;
        }
        
        .export-button {
            width: 100%;
            padding: 12px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background-color 0.3s;
        }
        
        .export-button:hover:not(:disabled) {
            background-color: #2980b9;
        }
        
        .export-button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .export-icon {
            font-size: 20px;
        }
        
        /* è¿›åº¦å¼¹çª—æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            min-width: 400px;
            max-width: 500px;
        }
        
        .modal-content h3 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            text-align: center;
        }
        
        .progress-container {
            margin-bottom: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background-color: #ecf0f1;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
        }
        
        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        .modal-actions button {
            padding: 10px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .cancel-button {
            background-color: #e74c3c;
            color: white;
        }
        
        .cancel-button:hover {
            background-color: #c0392b;
        }
        
        .success-message {
            color: #27ae60;
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .error-message {
            color: #e74c3c;
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        /* å¯¼å‡ºè®¾ç½®å¼¹çª—æ ·å¼ */
        .export-settings {
            margin-bottom: 20px;
        }
        
        .setting-item {
            margin-bottom: 15px;
        }
        
        .setting-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .fps-select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .fps-select option:disabled {
            color: #999;
        }
        
        .filename-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .modal-actions button.export-button {
            background-color: #27ae60;
            color: white;
        }
        
        .modal-actions button.export-button:hover {
            background-color: #229954;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 style="margin-bottom: 0;">è§†é¢‘å®æ—¶æ ‡è®°ç³»ç»ŸDemo</h1>
            <a href="/training" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: bold; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: transform 0.2s, box-shadow 0.2s;">
                ğŸ¯ æ¨¡å‹è®­ç»ƒ
            </a>
        </div>
        
        <div class="upload-section">
            <form class="upload-form" action="/upload" method="post" enctype="multipart/form-data">
                <input type="file" name="video" accept="video/*" required>
                <button type="submit">ä¸Šä¼ è§†é¢‘</button>
            </form>
        </div>
        
        <div class="main-content">
            <div class="video-section">
                {% if video %}
                    <div style="position: relative; display: inline-block; width: 100%;" id="video-container" onclick="handleVideoClick(event)">
                        <video id="original-video" controls style="width: 100%;" onclick="event.preventDefault();">
                            <source src="/static/uploads/{{ video }}" type="video/mp4">
                            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
                        </video>
                        <canvas id="detection-canvas" style="position: absolute; top: 0; left: 0; width: 100%; height: auto; pointer-events: none;"></canvas>
                    </div>
                    
                    <div style="position: relative; display: inline-block; width: 100%; display: none;">
                        <video id="processed-video" controls style="width: 100%;" onclick="event.preventDefault();">
                            <source id="processed-source" src="" type="video/mp4">
                            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
                        </video>
                    </div>
                    
                    <div class="video-controls">
                        <button id="detect-btn" onclick="detectObjects()">å¼€å§‹æ£€æµ‹</button>
                        <button id="reset-btn" onclick="resetVideo()">é‡ç½®</button>
                    </div>
                    
                    <div id="video-info" class="video-info">
                        <div class="info-item">
                            <span class="info-label">åˆ†è¾¨ç‡:</span>
                            <span id="video-resolution">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">å¸§ç‡:</span>
                            <span id="video-fps">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">æ—¶é•¿:</span>
                            <span id="video-duration">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">æ€»å¸§æ•°:</span>
                            <span id="video-frames">-</span>
                        </div>
                    </div>
                    
                    <div id="status" class="status">
                        è¯·é€‰æ‹©è¦æ£€æµ‹çš„ç‰©å“ï¼Œç„¶åç‚¹å‡»"å¼€å§‹æ£€æµ‹"æŒ‰é’®ã€‚
                    </div>
                    
                    <div class="timeline-section">
                        <div class="timeline-header">
                            <h4>ç‰©ä½“æ£€æµ‹æ—¶é—´è½´</h4>
                            <div class="timeline-controls">
                                <label for="timeline-refresh-rate">åˆ·æ–°é¢‘ç‡:</label>
                                <select id="timeline-refresh-rate" onchange="updateTimelineRefreshRate()">
                                    <option value="1">é€å¸§åˆ·æ–°</option>
                                    <option value="2" selected>1/2å¸§ç‡åˆ·æ–°</option>
                                    <option value="4">1/4å¸§ç‡åˆ·æ–°</option>
                                    <option value="10">1/10å¸§ç‡åˆ·æ–°</option>
                                </select>
                                <div class="timeline-info" id="timeline-info">æ—¶é—´: 00:00:00</div>
                            </div>
                        </div>
                        <div class="timeline-container">
                            <canvas id="timeline-chart"></canvas>
                        </div>
                    </div>
                {% else %}
                    <div style="text-align: center; padding: 50px; color: #666;">
                        è¯·å…ˆä¸Šä¼ è§†é¢‘æ–‡ä»¶
                    </div>
                {% endif %}
            </div>
            
            <div class="controls-section">
                <h3 style="margin-bottom: 15px;">æ¨¡å‹é€‰æ‹©</h3>
                <div style="margin-bottom: 20px;">
                    <select id="model-select" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;">
                        {% for model_name in trained_models %}
                            <option value="{{ model_name }}" {% if model_name == default_model %}selected{% endif %}>{{ model_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <h3 style="display: flex; justify-content: space-between; align-items: center;">
                    é€‰æ‹©æ£€æµ‹ç‰©å“
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll()" style="transform: scale(1.2);">
                        <label for="select-all-checkbox" style="user-select: none; cursor: pointer;">å…¨é€‰</label>
                    </div>
                </h3>
                <div class="classes-grid">
                    {% for class_id, class_name in classes.items() %}
                        <div class="class-item">
                            <input type="checkbox" id="class-{{ class_id }}" value="{{ class_name }}">
                            <label for="class-{{ class_id }}">{{ class_name }}</label>
                        </div>
                    {% endfor %}
                </div>
                
                {% if video %}
                <div class="export-section">
                    <button id="export-btn" class="export-button" onclick="initiateExport()">
                        <span class="export-icon">ğŸ“¥</span>
                        å¯¼å‡ºæ ‡æ³¨è§†é¢‘
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- å¯¼å‡ºè®¾ç½®å¼¹çª— -->
    <div id="export-settings-modal" class="modal">
        <div class="modal-content">
            <h3>å¯¼å‡ºè®¾ç½®</h3>
            <div class="export-settings">
                <div class="setting-item">
                    <label for="output-fps">è¾“å‡ºå¸§ç‡:</label>
                    <select id="output-fps" class="fps-select">
                        <option value="original">åŸå§‹å¸§ç‡</option>
                        <option value="60">60 fps</option>
                        <option value="30">30 fps</option>
                        <option value="24">24 fps</option>
                        <option value="15">15 fps</option>
                        <option value="10">10 fps</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label for="output-filename">æ–‡ä»¶å:</label>
                    <input type="text" id="output-filename" class="filename-input" placeholder="annotated_video.mp4">
                </div>
            </div>
            <div class="modal-actions">
                <button class="cancel-button" onclick="hideExportSettingsModal()">å–æ¶ˆ</button>
                <button class="export-button" onclick="confirmExport()">å¼€å§‹å¯¼å‡º</button>
            </div>
        </div>
    </div>
    
    <!-- å¯¼å‡ºè¿›åº¦å¼¹çª— -->
    <div id="export-modal" class="modal">
        <div class="modal-content">
            <h3>å¯¼å‡ºè¿›åº¦</h3>
            <div id="export-message"></div>
            <div class="progress-container">
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
                <div class="progress-text">
                    <span id="progress-percentage">0%</span>
                    <span id="progress-frames">0 / 0 å¸§</span>
                </div>
            </div>
            <div class="modal-actions">
                <button id="cancel-export-btn" class="cancel-button" onclick="cancelExport()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <script>
        // æ—¶é—´è½´ç›¸å…³å˜é‡
        let timelineChart = null;
        let detectionTimeline = {}; // å­˜å‚¨æ¯ä¸ªç‰©ä½“çš„æ£€æµ‹æ—¶é—´æ®µ {className: [{start, end}]}
        let currentDetections = {}; // å½“å‰æ­£åœ¨æ£€æµ‹çš„ç‰©ä½“ {className: startTime}
        let timelineRefreshRate = 2; // æ—¶é—´è½´åˆ·æ–°é¢‘ç‡ï¼ˆæ¯Nå¸§åˆ·æ–°ä¸€æ¬¡ï¼‰
        let frameCounter = 0; // å¸§è®¡æ•°å™¨
        
        // å¯¼å‡ºç›¸å…³å˜é‡
        let isExporting = false;
        let currentExportTaskId = null;
        let exportProgressInterval = null;
        let currentVideoFps = 30; // å½“å‰è§†é¢‘å¸§ç‡ï¼Œé»˜è®¤30
        
        function getSelectedClasses() {
            const checkboxes = document.querySelectorAll('.class-item input[type="checkbox"]');
            const selected = [];
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    selected.push(cb.value);
                }
            });
            return selected;
        }
        
        // å®æ—¶æ£€æµ‹ç›¸å…³å˜é‡
        let isDetecting = false;
        let videoElement = null;
        let canvasElement = null;
        let canvasContext = null;
        let socket = null;
        
        // ä¸ºæ‰€æœ‰å¤é€‰æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {
            // ä¸ºç±»åˆ«å¤é€‰æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const checkboxes = document.querySelectorAll('.class-item input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.addEventListener('change', handleClassChange);
            });
            
            // ä¸ºå…¨é€‰å¤é€‰æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', handleClassChange);
            }
            
            // åˆå§‹åŒ–WebSocketè¿æ¥
            initWebSocket();
            
            // åˆå§‹åŒ–æ—¶é—´è½´
            initTimeline();
            
            // åˆå§‹åŒ–è§†é¢‘ä¿¡æ¯æ˜¾ç¤º
            initVideoInfo();
        });
        
        // åˆå§‹åŒ–WebSocketè¿æ¥
        function initWebSocket() {
            // ä½¿ç”¨åŸç”ŸWebSocketè¿æ¥FastAPIåç«¯
            socket = new WebSocket(`ws://${window.location.host}/ws`);
            
            // ç›‘å¬è¿æ¥æ‰“å¼€äº‹ä»¶
            socket.onopen = function() {
                console.log('WebSocketè¿æ¥å·²å»ºç«‹');
            };
            
            // ç›‘å¬æ£€æµ‹ç»“æœ
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.detections) {
                    drawDetections(data.detections);
                } else if (data.error) {
                    console.error('æ£€æµ‹é”™è¯¯:', data.error);
                }
            };
            
            // ç›‘å¬è¿æ¥å…³é—­äº‹ä»¶
            socket.onclose = function() {
                console.log('WebSocketè¿æ¥å·²æ–­å¼€');
            };
            
            // ç›‘å¬é”™è¯¯äº‹ä»¶
            socket.onerror = function(error) {
                console.error('WebSocketé”™è¯¯:', error);
            };
        }
        
        // å¤„ç†ç±»åˆ«é€‰æ‹©å˜åŒ–
        function handleClassChange() {
            if (isDetecting) {
                // ä¿å­˜å½“å‰æŒ‰é’®æ–‡æœ¬çŠ¶æ€
                const detectBtn = document.getElementById('detect-btn');
                const btnText = detectBtn.textContent;
                
                // å†…éƒ¨é‡ç½®å‡½æ•°ï¼Œä¸æ”¹å˜æŒ‰é’®çŠ¶æ€
                function internalReset() {
                    // åœæ­¢æ£€æµ‹ä½†ä¸æ”¹å˜æŒ‰é’®çŠ¶æ€
                    isDetecting = false;
                    if (streamInterval) {
                        clearInterval(streamInterval);
                        streamInterval = null;
                    }
                    // æ¸…ç©ºæ£€æµ‹ç”»å¸ƒ
                    if (detectionContext && detectionCanvas) {
                        detectionContext.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);
                    }
                }
                
                // æ‰§è¡Œå†…éƒ¨é‡ç½®
                internalReset();
                
                // é‡æ–°å¼€å§‹æ£€æµ‹
                detectObjects();
                
                // æ¢å¤æŒ‰é’®æ–‡æœ¬çŠ¶æ€
                detectBtn.textContent = btnText;
            }
        }
        let detectionCanvas = null;
        let detectionContext = null;
        let streamInterval = null;
        
        function initCanvas() {
            videoElement = document.getElementById('original-video');
            canvasElement = document.createElement('canvas');
            canvasContext = canvasElement.getContext('2d');
            detectionCanvas = document.getElementById('detection-canvas');
            detectionContext = detectionCanvas.getContext('2d');
            
            // è®¾ç½®canvaså°ºå¯¸ä¸è§†é¢‘ä¸€è‡´
            videoElement.addEventListener('loadedmetadata', function() {
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
                detectionCanvas.width = videoElement.videoWidth;
                detectionCanvas.height = videoElement.videoHeight;
                // è§†é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆåæ›´æ–°Canvasæ˜¾ç¤ºå°ºå¯¸
                updateCanvasSize();
            });
            
            // ç›‘å¬è§†é¢‘åŠ è½½å®Œæˆäº‹ä»¶ï¼Œç¡®ä¿è§†é¢‘å…ƒç´ å°ºå¯¸ç¡®å®šåæ›´æ–°Canvas
            videoElement.addEventListener('loadeddata', updateCanvasSize);
            
            // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œç¡®ä¿Canvasæ˜¾ç¤ºå°ºå¯¸ä¸è§†é¢‘ä¸€è‡´
            window.addEventListener('resize', updateCanvasSize);
            
            // åˆå§‹æ›´æ–°ä¸€æ¬¡
            updateCanvasSize();
        }
        
        function updateCanvasSize() {
            if (!videoElement || !detectionCanvas) return;
            
            const container = document.getElementById('video-container');
            const videoRect = videoElement.getBoundingClientRect();
            
            // è®¾ç½®Canvasçš„æ˜¾ç¤ºå°ºå¯¸ä¸è§†é¢‘å…ƒç´ çš„å®é™…æ˜¾ç¤ºå°ºå¯¸ä¸€è‡´
            detectionCanvas.style.width = videoRect.width + 'px';
            detectionCanvas.style.height = videoRect.height + 'px';
        }
        
        function detectObjects() {
            const selectedClasses = getSelectedClasses();
            
            // æ£€æŸ¥è§†é¢‘å…ƒç´ æ˜¯å¦å­˜åœ¨
            const videoElement = document.getElementById('original-video');
            if (!videoElement) {
                showStatus('è¯·å…ˆä¸Šä¼ è§†é¢‘', 'error');
                return;
            }
            
            if (selectedClasses.length === 0) {
                showStatus('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦æ£€æµ‹çš„ç‰©å“', 'error');
                return;
            }
            
            if (!isDetecting) {
                // å¼€å§‹å®æ—¶æ£€æµ‹
                isDetecting = true;
                initCanvas();
                showStatus('æ­£åœ¨è¿›è¡Œå®æ—¶æ£€æµ‹...', '');
                document.getElementById('detect-btn').textContent = 'åœæ­¢æ£€æµ‹';
                
                // å¼€å§‹æ•è·è§†é¢‘å¸§å¹¶å‘é€åˆ°æœåŠ¡å™¨
                streamInterval = setInterval(() => {
                    if (!videoElement.paused && !videoElement.ended) {
                        // æ•è·å½“å‰è§†é¢‘å¸§
                        canvasContext.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
                        
                        // å°†canvasè½¬æ¢ä¸ºbase64å­—ç¬¦ä¸²
                        const frameData = canvasElement.toDataURL('image/jpeg');
                        
                        // è·å–ç”¨æˆ·é€‰æ‹©çš„æ¨¡å‹
                        const selectedModel = document.getElementById('model-select').value;
                        
                        try {
                            // é€šè¿‡WebSocketå‘é€å¸§æ•°æ®åˆ°æœåŠ¡å™¨è¿›è¡Œæ£€æµ‹
                            socket.send(JSON.stringify({
                                frame_data: frameData.split(',')[1], // ç§»é™¤base64å‰ç¼€
                                selected_classes: selectedClasses,
                                selected_model: selectedModel
                            }));
                        } catch (error) {
                            console.error('æ£€æµ‹è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
                        }
                    }
                }, 100); // æ¯100æ¯«ç§’å‘é€ä¸€å¸§
            } else {
                // åœæ­¢å®æ—¶æ£€æµ‹
                stopDetection();
            }
        }
        
        function stopDetection() {
            isDetecting = false;
            if (streamInterval) {
                clearInterval(streamInterval);
                streamInterval = null;
            }
            // æ¸…ç©ºæ£€æµ‹ç”»å¸ƒ
            if (detectionContext && detectionCanvas) {
                detectionContext.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);
            }
            showStatus('è¯·é€‰æ‹©è¦æ£€æµ‹çš„ç‰©å“ï¼Œç„¶åç‚¹å‡»"å¼€å§‹æ£€æµ‹"æŒ‰é’®ã€‚', '');
            document.getElementById('detect-btn').textContent = 'å¼€å§‹æ£€æµ‹';
        }
        
        function resetVideo() {
            stopDetection();
            const processedVideo = document.getElementById('processed-video');
            const originalVideo = document.getElementById('original-video');
            
            processedVideo.style.display = 'none';
            originalVideo.style.display = 'block';
            
            // æ¸…ç©ºæ—¶é—´è½´æ•°æ®
            detectionTimeline = {};
            currentDetections = {};
            frameCounter = 0;
            updateTimeline();
            
            showStatus('è¯·é€‰æ‹©è¦æ£€æµ‹çš„ç‰©å“ï¼Œç„¶åç‚¹å‡»"å¼€å§‹æ£€æµ‹"æŒ‰é’®ã€‚', '');
        }
        
        function handleVideoClick(event) {
            if (!videoElement) {
                initCanvas();
            }
            
            // è·å–è§†é¢‘å…ƒç´ 
            const video = videoElement;
            const container = document.getElementById('video-container');
            
            // è®¡ç®—ç‚¹å‡»ä½ç½®åœ¨è§†é¢‘å®é™…å°ºå¯¸ä¸­çš„åæ ‡
            const rect = container.getBoundingClientRect();
            const scaleX = video.videoWidth / rect.width;
            const scaleY = video.videoHeight / rect.height;
            
            const clickX = (event.clientX - rect.left) * scaleX;
            const clickY = (event.clientY - rect.top) * scaleY;
            
            // æ•è·å½“å‰è§†é¢‘å¸§
            canvasContext.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
            
            // å°†canvasè½¬æ¢ä¸ºbase64å­—ç¬¦ä¸²
            const frameData = canvasElement.toDataURL('image/jpeg');
            
            // å‘é€åˆ°æœåŠ¡å™¨è¿›è¡Œæ£€æµ‹
            fetch('/detect_click', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    frame_data: frameData.split(',')[1], // ç§»é™¤base64å‰ç¼€
                    click_x: clickX,
                    click_y: clickY,
                    selected_model: document.getElementById('model-select').value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showStatus(data.error, 'error');
                } else if (data.detected_class) {
                    // è‡ªåŠ¨å‹¾é€‰è¯†åˆ«åˆ°çš„ç±»åˆ«
                    const className = data.detected_class;
                    const checkbox = document.querySelector(`.class-item input[type="checkbox"][value="${className}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        showStatus(`å·²è¯†åˆ«å¹¶å‹¾é€‰: ${className}`, 'success');
                        // è§¦å‘ç±»åˆ«å˜åŒ–å¤„ç†ï¼Œç¡®ä¿æ£€æµ‹é€»è¾‘é‡æ–°æ‰§è¡Œ
                        handleClassChange();
                    } else {
                        showStatus(`è¯†åˆ«åˆ°: ${className}ï¼Œä½†æœªæ‰¾åˆ°å¯¹åº”é€‰é¡¹`, '');
                    }
                } else {
                    showStatus('æœªè¯†åˆ«åˆ°ç‰©ä½“', 'error');
                }
            })
            .catch(error => {
                console.error('æ£€æµ‹è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
                showStatus('æ£€æµ‹è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯', 'error');
            });
        }
        
        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function drawDetections(detections) {
            // æ¸…ç©ºç”»å¸ƒ
            detectionContext.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);
            
            // è·å–å½“å‰è§†é¢‘æ—¶é—´
            const currentTime = videoElement.currentTime;
            
            // è®°å½•å½“å‰å¸§æ£€æµ‹åˆ°çš„ç‰©ä½“
            const detectedClasses = new Set();
            
            // ç»˜åˆ¶æ£€æµ‹ç»“æœ
            detections.forEach(detection => {
                const { x1, y1, x2, y2, class_name, confidence } = detection;
                
                detectedClasses.add(class_name);
                
                // ç»˜åˆ¶è¾¹ç•Œæ¡†
                detectionContext.strokeStyle = '#00FF00';
                detectionContext.lineWidth = 2;
                detectionContext.strokeRect(x1, y1, x2 - x1, y2 - y1);
                
                // ç»˜åˆ¶æ ‡ç­¾èƒŒæ™¯
                detectionContext.fillStyle = '#00FF00';
                const label = `${class_name}: ${confidence.toFixed(2)}`;
                const textWidth = detectionContext.measureText(label).width;
                detectionContext.fillRect(x1, y1 - 20, textWidth + 10, 20);
                
                // ç»˜åˆ¶æ ‡ç­¾æ–‡æœ¬
                detectionContext.fillStyle = '#000000';
                detectionContext.font = '14px Arial';
                detectionContext.fillText(label, x1 + 5, y1 - 5);
            });
            
            // å¢åŠ å¸§è®¡æ•°å™¨
            frameCounter++;
            
            // æ ¹æ®åˆ·æ–°é¢‘ç‡æ›´æ–°æ—¶é—´è½´æ•°æ®
            if (frameCounter >= timelineRefreshRate) {
                updateDetectionTimeline(detectedClasses, currentTime);
                frameCounter = 0;
            }
        }
        
        // æ ¹æ®å¤é€‰æ¡†çŠ¶æ€åˆ‡æ¢å…¨é€‰/å…¨éƒ¨å–æ¶ˆ
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const checkboxes = document.querySelectorAll('.class-item input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = selectAllCheckbox.checked;
            });
        }
        
        // åˆå§‹åŒ–æ—¶é—´è½´
        function initTimeline() {
            const canvas = document.getElementById('timeline-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // è‡ªå®šä¹‰æ’ä»¶ï¼šç»˜åˆ¶è·Ÿéšé¼ æ ‡çš„å‚ç›´çº¿
            const verticalLinePlugin = {
                id: 'verticalLine',
                afterDraw: (chart) => {
                    if (chart.tooltip._active && chart.tooltip._active.length) {
                        const activePoint = chart.tooltip._active[0];
                        const ctx = chart.ctx;
                        const x = activePoint.element.x;
                        const topY = chart.scales.y.top;
                        const bottomY = chart.scales.y.bottom;
                        
                        // ç»˜åˆ¶å‚ç›´çº¿
                        ctx.save();
                        ctx.beginPath();
                        ctx.moveTo(x, topY);
                        ctx.lineTo(x, bottomY);
                        ctx.lineWidth = 1;
                        ctx.strokeStyle = '#666';
                        ctx.setLineDash([5, 5]);
                        ctx.stroke();
                        ctx.restore();
                    }
                }
            };
            
            timelineChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            min: 0,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return formatTime(value);
                                }
                            },
                            title: {
                                display: true,
                                text: 'è§†é¢‘æ—¶é—´è½´'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'æ£€æµ‹ç‰©ä½“'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    const start = context.raw.x[0];
                                    const end = context.raw.x[1];
                                    return `æ—¶é—´æ®µ: ${formatTime(start)} - ${formatTime(end)}`;
                                },
                                afterLabel: function(context) {
                                    const value = context.parsed.x;
                                    return `å½“å‰ä½ç½®: ${formatTime(value)}`;
                                }
                            }
                        }
                    },
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0 || event.x) {
                            // è®¡ç®—ç‚¹å‡»ä½ç½®å¯¹åº”çš„æ—¶é—´
                            const chart = timelineChart;
                            const canvasPosition = Chart.helpers.getRelativePosition(event, chart);
                            const dataX = chart.scales.x.getValueForPixel(canvasPosition.x);
                            
                            // è·³è½¬è§†é¢‘åˆ°è¯¥æ—¶é—´
                            if (videoElement && dataX >= 0) {
                                videoElement.currentTime = dataX;
                            }
                        }
                    },
                    onHover: (event, activeElements) => {
                        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
                        const chart = timelineChart;
                        const canvasPosition = Chart.helpers.getRelativePosition(event, chart);
                        const dataX = chart.scales.x.getValueForPixel(canvasPosition.x);
                        
                        if (dataX >= 0) {
                            const timeInfo = document.getElementById('timeline-info');
                            if (timeInfo) {
                                timeInfo.textContent = `æ—¶é—´: ${formatTime(dataX)}`;
                            }
                        }
                    }
                },
                plugins: [verticalLinePlugin]
            });
            
            // ç›‘å¬canvasçš„é¼ æ ‡ç§»åŠ¨äº‹ä»¶
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // è§¦å‘å›¾è¡¨æ›´æ–°ä»¥æ˜¾ç¤ºå‚ç›´çº¿
                timelineChart.update('none');
            });
        }
        
        // æ ¼å¼åŒ–æ—¶é—´ï¼ˆç§’è½¬æ¢ä¸º æ—¶:åˆ†:ç§’ï¼‰
        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }
        
        // æ›´æ–°æ£€æµ‹æ—¶é—´è½´æ•°æ®
        function updateDetectionTimeline(detectedClasses, currentTime) {
            let needsUpdate = false;
            
            // å¤„ç†æ–°æ£€æµ‹åˆ°çš„ç‰©ä½“
            detectedClasses.forEach(className => {
                if (!currentDetections[className]) {
                    // ç‰©ä½“é¦–æ¬¡å‡ºç°ï¼Œè®°å½•å¼€å§‹æ—¶é—´
                    currentDetections[className] = currentTime;
                    needsUpdate = true; // æ–°ç‰©ä½“å‡ºç°ï¼Œéœ€è¦æ›´æ–°å›¾è¡¨
                }
            });
            
            // å¤„ç†æ¶ˆå¤±çš„ç‰©ä½“
            Object.keys(currentDetections).forEach(className => {
                if (!detectedClasses.has(className)) {
                    // ç‰©ä½“æ¶ˆå¤±ï¼Œè®°å½•æ—¶é—´æ®µ
                    const startTime = currentDetections[className];
                    const endTime = currentTime;
                    
                    if (!detectionTimeline[className]) {
                        detectionTimeline[className] = [];
                    }
                    
                    // åˆå¹¶ç›¸è¿‘çš„æ—¶é—´æ®µï¼ˆé—´éš”å°äº0.5ç§’ï¼‰
                    const lastSegment = detectionTimeline[className][detectionTimeline[className].length - 1];
                    if (lastSegment && startTime - lastSegment.end < 0.5) {
                        lastSegment.end = endTime;
                    } else {
                        detectionTimeline[className].push({
                            start: startTime,
                            end: endTime
                        });
                    }
                    
                    delete currentDetections[className];
                    needsUpdate = true; // ç‰©ä½“æ¶ˆå¤±ï¼Œéœ€è¦æ›´æ–°å›¾è¡¨
                }
            });
            
            // å¦‚æœæœ‰å˜åŒ–ï¼Œæ›´æ–°æ—¶é—´è½´æ˜¾ç¤º
            if (needsUpdate || Object.keys(currentDetections).length > 0) {
                updateTimeline(currentTime);
            }
        }
        
        // æ›´æ–°æ—¶é—´è½´å›¾è¡¨
        function updateTimeline(currentTime) {
            if (!timelineChart || !videoElement) return;
            
            const videoDuration = videoElement.duration || 100;
            const now = currentTime !== undefined ? currentTime : videoElement.currentTime;
            
            // æ›´æ–°xè½´æœ€å¤§å€¼ä¸ºè§†é¢‘æ€»æ—¶é•¿
            timelineChart.options.scales.x.max = videoDuration;
            
            // å‡†å¤‡æ•°æ®é›†
            const labels = new Set();
            const datasets = [];
            const colorMap = {}; // ä¿æŒé¢œè‰²ä¸€è‡´æ€§
            
            // æ”¶é›†æ‰€æœ‰ç‰©ä½“ç±»åˆ«ï¼ˆåŒ…æ‹¬å·²å®Œæˆå’Œæ­£åœ¨æ£€æµ‹çš„ï¼‰
            let colorIndex = 0;
            [...Object.keys(detectionTimeline), ...Object.keys(currentDetections)].forEach(className => {
                if (!colorMap[className]) {
                    const hue = (colorIndex * 137.5) % 360;
                    colorMap[className] = `hsla(${hue}, 70%, 60%, 0.8)`;
                    colorIndex++;
                }
            });
            
            // 1. æ·»åŠ å·²å®Œæˆçš„æ—¶é—´æ®µ
            Object.keys(detectionTimeline).forEach((className) => {
                const segments = detectionTimeline[className];
                
                if (segments.length > 0) {
                    labels.add(className);
                    
                    // ä¸ºæ¯ä¸ªæ—¶é—´æ®µåˆ›å»ºæ•°æ®ç‚¹
                    const data = segments.map(segment => ({
                        x: [segment.start, segment.end],
                        y: className
                    }));
                    
                    datasets.push({
                        label: className,
                        data: data,
                        backgroundColor: colorMap[className],
                        borderColor: colorMap[className],
                        borderWidth: 1,
                        barThickness: 20
                    });
                }
            });
            
            // 2. æ·»åŠ æ­£åœ¨æ£€æµ‹ä¸­çš„ç‰©ä½“ï¼ˆå®æ—¶æ›´æ–°åˆ°å½“å‰æ—¶é—´ï¼‰
            Object.keys(currentDetections).forEach((className) => {
                labels.add(className);
                
                const startTime = currentDetections[className];
                
                // æŸ¥æ‰¾è¯¥ç‰©ä½“æ˜¯å¦å·²æœ‰æ•°æ®é›†
                let dataset = datasets.find(ds => ds.label === className);
                
                if (dataset) {
                    // å·²æœ‰æ•°æ®é›†ï¼Œæ·»åŠ å½“å‰æ­£åœ¨æ£€æµ‹çš„æ—¶é—´æ®µ
                    dataset.data.push({
                        x: [startTime, now],
                        y: className
                    });
                } else {
                    // æ–°ç‰©ä½“ï¼Œåˆ›å»ºæ–°æ•°æ®é›†
                    datasets.push({
                        label: className,
                        data: [{
                            x: [startTime, now],
                            y: className
                        }],
                        backgroundColor: colorMap[className],
                        borderColor: colorMap[className],
                        borderWidth: 1,
                        barThickness: 20
                    });
                }
            });
            
            // æ›´æ–°å›¾è¡¨æ•°æ®
            const labelsArray = Array.from(labels);
            timelineChart.data.labels = labelsArray;
            timelineChart.data.datasets = datasets;
            
            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œéšè—yè½´
            timelineChart.options.scales.y.display = labelsArray.length > 0;
            
            // è‡ªåŠ¨è°ƒæ•´æ—¶é—´è½´é«˜åº¦å’Œæ¡å½¢ç²—ç»†
            adjustTimelineHeight(labelsArray.length);
            
            // ä½¿ç”¨ 'none' æ¨¡å¼æ›´æ–°ï¼Œç¦ç”¨åŠ¨ç”»
            timelineChart.update('none');
        }
        
        // è‡ªåŠ¨è°ƒæ•´æ—¶é—´è½´é«˜åº¦å’Œæ¡å½¢ç²—ç»†
        function adjustTimelineHeight(itemCount) {
            if (itemCount === 0) return;
            
            const container = document.getElementById('timeline-chart').parentElement;
            const minHeight = 200;
            const maxHeight = 600;
            const barHeight = 20; // æ¯ä¸ªæ¡å½¢çš„åŸºç¡€é«˜åº¦
            const padding = 60; // å›¾è¡¨çš„ä¸Šä¸‹padding
            
            // è®¡ç®—éœ€è¦çš„é«˜åº¦
            const requiredHeight = itemCount * (barHeight + 10) + padding; // 10æ˜¯é—´è·
            
            // ç¡®å®šå®é™…é«˜åº¦
            let actualHeight = Math.max(minHeight, Math.min(maxHeight, requiredHeight));
            
            // å¦‚æœç‰©å“å¤ªå¤šï¼Œéœ€è¦ç¼©æ”¾
            if (requiredHeight > maxHeight) {
                // è®¡ç®—ç¼©æ”¾åçš„æ¡å½¢ç²—ç»†
                const availableHeight = maxHeight - padding;
                const scaledBarHeight = Math.floor(availableHeight / itemCount) - 10;
                const finalBarHeight = Math.max(8, scaledBarHeight); // æœ€å°8px
                
                // æ›´æ–°æ‰€æœ‰æ•°æ®é›†çš„barThickness
                timelineChart.data.datasets.forEach(dataset => {
                    dataset.barThickness = finalBarHeight;
                });
                
                actualHeight = maxHeight;
                
                console.log(`æ—¶é—´è½´è‡ªåŠ¨ç¼©æ”¾: ${itemCount}ä¸ªç‰©å“, æ¡å½¢é«˜åº¦: ${finalBarHeight}px`);
            } else {
                // æ¢å¤é»˜è®¤æ¡å½¢ç²—ç»†
                timelineChart.data.datasets.forEach(dataset => {
                    dataset.barThickness = barHeight;
                });
            }
            
            // è®¾ç½®å®¹å™¨é«˜åº¦
            container.style.height = actualHeight + 'px';
        }
        
        // æ›´æ–°æ—¶é—´è½´åˆ·æ–°é¢‘ç‡
        function updateTimelineRefreshRate() {
            const select = document.getElementById('timeline-refresh-rate');
            timelineRefreshRate = parseInt(select.value);
            frameCounter = 0; // é‡ç½®å¸§è®¡æ•°å™¨
            console.log(`æ—¶é—´è½´åˆ·æ–°é¢‘ç‡å·²æ›´æ–°ä¸º: æ¯${timelineRefreshRate}å¸§åˆ·æ–°ä¸€æ¬¡`);
        }
        
        // ==================== è§†é¢‘ä¿¡æ¯æ˜¾ç¤º ====================
        
        // åˆå§‹åŒ–è§†é¢‘ä¿¡æ¯æ˜¾ç¤º
        function initVideoInfo() {
            const videoElement = document.getElementById('original-video');
            if (!videoElement) return;
            
            // ç›‘å¬è§†é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆ
            videoElement.addEventListener('loadedmetadata', function() {
                updateVideoInfo();
            });
            
            // å¦‚æœå·²ç»åŠ è½½ï¼Œç«‹å³æ›´æ–°
            if (videoElement.readyState >= 1) {
                updateVideoInfo();
            }
        }
        
        // æ›´æ–°è§†é¢‘ä¿¡æ¯æ˜¾ç¤º
        function updateVideoInfo() {
            const videoElement = document.getElementById('original-video');
            if (!videoElement) return;
            
            const width = videoElement.videoWidth;
            const height = videoElement.videoHeight;
            const duration = videoElement.duration;
            
            // è·å–å¸§ç‡ï¼ˆé€šè¿‡åç«¯APIæˆ–ä¼°ç®—ï¼‰
            // æ³¨æ„ï¼šHTML5 video APIä¸ç›´æ¥æä¾›å¸§ç‡ï¼Œè¿™é‡Œä½¿ç”¨ä¼°ç®—å€¼
            // å®é™…é¡¹ç›®ä¸­åº”è¯¥ä»åç«¯è·å–å‡†ç¡®çš„å¸§ç‡
            fetchVideoMetadata();
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('video-resolution').textContent = `${width} Ã— ${height}`;
            document.getElementById('video-duration').textContent = formatTime(duration);
        }
        
        // ä»åç«¯è·å–è§†é¢‘å…ƒæ•°æ®
        async function fetchVideoMetadata() {
            const videoElement = document.getElementById('original-video');
            const videoSource = videoElement.querySelector('source');
            if (!videoSource || !videoSource.src) return;
            
            const videoFilename = decodeURIComponent(videoSource.src.split('/').pop());
            
            try {
                const response = await fetch('/video/metadata', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        video_filename: videoFilename
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentVideoFps = data.fps || 30;
                    const totalFrames = data.total_frames || Math.round(videoElement.duration * currentVideoFps);
                    
                    document.getElementById('video-fps').textContent = `${currentVideoFps.toFixed(2)} fps`;
                    document.getElementById('video-frames').textContent = totalFrames.toLocaleString();
                    
                    // æ›´æ–°å¸§ç‡é€‰æ‹©å™¨
                    updateFpsOptions();
                }
            } catch (error) {
                console.error('è·å–è§†é¢‘å…ƒæ•°æ®å¤±è´¥:', error);
                // ä½¿ç”¨é»˜è®¤å€¼
                document.getElementById('video-fps').textContent = '30.00 fps (ä¼°ç®—)';
                document.getElementById('video-frames').textContent = Math.round(videoElement.duration * 30).toLocaleString();
            }
        }
        
        // ==================== å¯¼å‡ºåŠŸèƒ½ ====================
        
        // æ›´æ–°å¸§ç‡é€‰é¡¹ï¼ˆç¦ç”¨é«˜äºå½“å‰è§†é¢‘å¸§ç‡çš„é€‰é¡¹ï¼‰
        function updateFpsOptions() {
            const fpsSelect = document.getElementById('output-fps');
            if (!fpsSelect) return;
            
            const options = fpsSelect.querySelectorAll('option');
            options.forEach(option => {
                const value = option.value;
                if (value !== 'original') {
                    const fps = parseInt(value);
                    if (fps > currentVideoFps) {
                        option.disabled = true;
                        option.textContent = `${fps} fps (é«˜äºåŸå§‹å¸§ç‡)`;
                    } else {
                        option.disabled = false;
                        option.textContent = `${fps} fps`;
                    }
                }
            });
        }
        
        // å¯åŠ¨å¯¼å‡ºæµç¨‹
        async function initiateExport() {
            // éªŒè¯ï¼šæ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†ç±»åˆ«
            const selectedClasses = getSelectedClasses();
            if (selectedClasses.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦æ£€æµ‹çš„ç‰©å“ç±»åˆ«');
                return;
            }
            
            // éªŒè¯ï¼šæ£€æŸ¥è§†é¢‘æ˜¯å¦åŠ è½½
            const videoElement = document.getElementById('original-video');
            if (!videoElement) {
                alert('è¯·å…ˆä¸Šä¼ è§†é¢‘');
                return;
            }
            
            // è·å–è§†é¢‘æº
            const videoSource = videoElement.querySelector('source');
            if (!videoSource || !videoSource.src) {
                alert('è¯·å…ˆä¸Šä¼ è§†é¢‘');
                return;
            }
            
            // ç”Ÿæˆé»˜è®¤è¾“å‡ºæ–‡ä»¶å
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const defaultFilename = `annotated_${timestamp}.mp4`;
            
            // è®¾ç½®é»˜è®¤æ–‡ä»¶å
            document.getElementById('output-filename').value = defaultFilename;
            
            // æ›´æ–°å¸§ç‡é€‰é¡¹
            updateFpsOptions();
            
            // æ˜¾ç¤ºå¯¼å‡ºè®¾ç½®å¼¹çª—
            showExportSettingsModal();
        }
        
        // æ˜¾ç¤ºå¯¼å‡ºè®¾ç½®å¼¹çª—
        function showExportSettingsModal() {
            const modal = document.getElementById('export-settings-modal');
            modal.classList.add('show');
        }
        
        // éšè—å¯¼å‡ºè®¾ç½®å¼¹çª—
        function hideExportSettingsModal() {
            const modal = document.getElementById('export-settings-modal');
            modal.classList.remove('show');
        }
        
        // ç¡®è®¤å¯¼å‡ºï¼ˆä»è®¾ç½®å¼¹çª—ï¼‰
        async function confirmExport() {
            // è·å–è®¾ç½®
            const outputFilename = document.getElementById('output-filename').value.trim();
            if (!outputFilename) {
                alert('è¯·è¾“å…¥æ–‡ä»¶å');
                return;
            }
            
            // ç¡®ä¿æ–‡ä»¶åä»¥.mp4ç»“å°¾
            const finalFilename = outputFilename.endsWith('.mp4') ? outputFilename : outputFilename + '.mp4';
            
            // è·å–å¸§ç‡è®¾ç½®
            const fpsSelect = document.getElementById('output-fps');
            const selectedFps = fpsSelect.value;
            
            // éšè—è®¾ç½®å¼¹çª—
            hideExportSettingsModal();
            
            // è·å–è§†é¢‘ä¿¡æ¯
            const videoElement = document.getElementById('original-video');
            const videoSource = videoElement.querySelector('source');
            const videoSrc = videoSource.src;
            const videoFilename = decodeURIComponent(videoSrc.split('/').pop());
            
            // è·å–é€‰æ‹©çš„ç±»åˆ«å’Œæ¨¡å‹
            const selectedClasses = getSelectedClasses();
            const selectedModel = document.getElementById('model-select').value;
            
            // ç¦ç”¨å¯¼å‡ºæŒ‰é’®
            const exportBtn = document.getElementById('export-btn');
            exportBtn.disabled = true;
            isExporting = true;
            
            try {
                // å‘é€å¯¼å‡ºè¯·æ±‚
                const response = await fetch('/export/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        video_filename: videoFilename,
                        selected_classes: selectedClasses,
                        selected_model: selectedModel,
                        output_filename: finalFilename,
                        output_fps: selectedFps === 'original' ? null : parseInt(selectedFps)
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'å¯¼å‡ºè¯·æ±‚å¤±è´¥');
                }
                
                const data = await response.json();
                currentExportTaskId = data.task_id;
                
                // æ˜¾ç¤ºè¿›åº¦å¼¹çª—
                showProgressModal();
                
                // å¼€å§‹è½®è¯¢è¿›åº¦
                startProgressPolling();
                
            } catch (error) {
                console.error('å¯¼å‡ºé”™è¯¯:', error);
                alert(`å¯¼å‡ºå¤±è´¥: ${error.message}`);
                exportBtn.disabled = false;
                isExporting = false;
            }
        }
        
        // æ˜¾ç¤ºè¿›åº¦å¼¹çª—
        function showProgressModal() {
            const modal = document.getElementById('export-modal');
            modal.classList.add('show');
            
            // é‡ç½®è¿›åº¦æ˜¾ç¤º
            document.getElementById('progress-fill').style.width = '0%';
            document.getElementById('progress-percentage').textContent = '0%';
            document.getElementById('progress-frames').textContent = '0 / 0 å¸§';
            document.getElementById('export-message').innerHTML = '';
            
            // æ˜¾ç¤ºå–æ¶ˆæŒ‰é’®
            document.getElementById('cancel-export-btn').style.display = 'block';
        }
        
        // éšè—è¿›åº¦å¼¹çª—
        function hideProgressModal() {
            const modal = document.getElementById('export-modal');
            modal.classList.remove('show');
        }
        
        // å¼€å§‹è½®è¯¢è¿›åº¦
        function startProgressPolling() {
            exportProgressInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/export/progress/${currentExportTaskId}`);
                    
                    if (!response.ok) {
                        throw new Error('è·å–è¿›åº¦å¤±è´¥');
                    }
                    
                    const data = await response.json();
                    
                    // æ›´æ–°è¿›åº¦æ˜¾ç¤º
                    updateProgress(data.processed_frames, data.total_frames, data.progress_percentage);
                    
                    // æ£€æŸ¥çŠ¶æ€
                    if (data.status === 'completed') {
                        stopProgressPolling();
                        showSuccess();
                    } else if (data.status === 'failed') {
                        stopProgressPolling();
                        showError(data.error_message || 'å¯¼å‡ºå¤±è´¥');
                    } else if (data.status === 'cancelled') {
                        stopProgressPolling();
                        showError('å¯¼å‡ºå·²å–æ¶ˆ');
                    }
                    
                } catch (error) {
                    console.error('è½®è¯¢è¿›åº¦é”™è¯¯:', error);
                }
            }, 500); // æ¯500msè½®è¯¢ä¸€æ¬¡
        }
        
        // åœæ­¢è½®è¯¢è¿›åº¦
        function stopProgressPolling() {
            if (exportProgressInterval) {
                clearInterval(exportProgressInterval);
                exportProgressInterval = null;
            }
        }
        
        // æ›´æ–°è¿›åº¦æ˜¾ç¤º
        function updateProgress(processedFrames, totalFrames, percentage) {
            const progressFill = document.getElementById('progress-fill');
            const progressPercentage = document.getElementById('progress-percentage');
            const progressFrames = document.getElementById('progress-frames');
            
            progressFill.style.width = percentage + '%';
            progressPercentage.textContent = Math.round(percentage) + '%';
            progressFrames.textContent = `${processedFrames} / ${totalFrames} å¸§`;
        }
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess() {
            const messageDiv = document.getElementById('export-message');
            messageDiv.innerHTML = '<div class="success-message">âœ… å¯¼å‡ºæˆåŠŸï¼</div>';
            
            // éšè—å–æ¶ˆæŒ‰é’®
            document.getElementById('cancel-export-btn').style.display = 'none';
            
            // 3ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(() => {
                hideProgressModal();
                resetExportState();
            }, 3000);
        }
        
        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            const messageDiv = document.getElementById('export-message');
            messageDiv.innerHTML = `<div class="error-message">âŒ ${message}</div>`;
            
            // éšè—å–æ¶ˆæŒ‰é’®
            document.getElementById('cancel-export-btn').style.display = 'none';
            
            // 3ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(() => {
                hideProgressModal();
                resetExportState();
            }, 3000);
        }
        
        // å–æ¶ˆå¯¼å‡º
        async function cancelExport() {
            if (!currentExportTaskId) return;
            
            try {
                const response = await fetch(`/export/cancel/${currentExportTaskId}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    stopProgressPolling();
                    showError('å¯¼å‡ºå·²å–æ¶ˆ');
                }
            } catch (error) {
                console.error('å–æ¶ˆå¯¼å‡ºé”™è¯¯:', error);
            }
        }
        
        // é‡ç½®å¯¼å‡ºçŠ¶æ€
        function resetExportState() {
            isExporting = false;
            currentExportTaskId = null;
            
            // é‡æ–°å¯ç”¨å¯¼å‡ºæŒ‰é’®
            const exportBtn = document.getElementById('export-btn');
            if (exportBtn) {
                exportBtn.disabled = false;
            }
        }
    </script>
</body>
</html>